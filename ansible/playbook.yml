---

- name: run the playbook tasks on the localhost
  hosts: localhost
  vars_files:
    - vars.yml
  vars:
    - vpn_bootstrap: false
  vars_prompt:
  - name: "vpn_password"
    prompt: "Enter VPN password"
    private: yes

  tasks:
  - name: Remove software
    dnf:
      name:
        - akonadi
        - akregator
        - calligra-core
        - dragon
        - falkon
        - juk
        - k3b
        - kaddressbooklibs
        - kdepim-runtime
        - kget
        - kleopatra
        - kmag
        - kmail
        - kmines
        - kmouth
        - kolourpaint
        - korganizer
        - kpat
        - krdc
        - krfb
        - kruler
        - krusader
        - ktnef
        - ktorrent
        - libkmahjongg
        - qt5-qdbusviewer
      state: absent

  - name: Gather package facts
    package_facts:
      manager: auto
    no_log: True

  # This is prerequisite for ansible to work on the host.
  - name: Install prerequisite software
    dnf:
      name:
        - python3-libselinux
        - python3-pexpect
      state: present

  - block:
    - name: Install bootstrap VPN
      unarchive:
        src: files/bootstrapvpn.tar
        dest: /
    - name: Activate network for bootstrap VPN
      command: nmcli connection reload
    - name: Establish temporary vpn filename
      shell: basename $(tar tf files/bootstrapvpn.tar */system-connections/* )
      register: vpn_filename
    - name: Note this action.
      set_fact:
        vpn_bootstrap: True
    when: '"redhat-internal-NetworkManager-openvpn-profiles-non-gnome" not in ansible_facts.packages'

  - block:
    - name: Connect to VPN
      expect:
        command: nmcli -a connection up '{{ vpn_connection }}'
        echo: yes
        responses:
          vpn.secrets.password: "{{ vpn_password }}"
      register: command_result
      # Handle double connection
      failed_when: '"is already active" not in command_result.stdout'
    # This will cause the play to fail if the VPN block is not activated.
    - debug:
        msg="Verifying VPN connection exists...( if not activate vpn connection by running nmcli -a connection up {{ vpn_connection }} )"
    - name: Check bootstrap VPN exists
      command: ip link show tun0 up

  - name: Install all package upgrades
    dnf: name=* state=latest

  - name: Add repositories
    include_role:
      name: repositories

  - name: Set hostname
    hostname:
      name: "{{ hostname }}"

  - name: Check GPG Key exists
    stat:
      path: /etc/pki/rpm-gpg/RPM-GPG-KEY-helpdesk
    register: stat_gpg_result
    no_log: True

  - name: Download GPG Key
    get_url:
      url: http://{{ csb_repo }}/rhel7-csb-stage/RPM-GPG-KEY-helpdesk
      dest: /etc/pki/rpm-gpg/RPM-GPG-KEY-helpdesk
    when: not stat_gpg_result.stat.exists

  - block:
    - name: Download SpiderOAK
      get_url:
        url: https://spideroak.com/release/spideroak/rpm_x64
        dest: /tmp/spider.rpm
    - name: Install SpiderOAK
      dnf:
        name: /tmp/spider.rpm
        state: present
    when: '"SpiderOak" not in ansible_facts.packages'

  - name: Install required software
    dnf:
      name:
        - CPUFreqUtility
        - ansible
#        - brewkoji
        - cherrytree
        - curl
        - digikam
        - dolphin
        - dropbox
        - emacs
        - emacs-auctex
        - emacs-color-theme
        - emacs-common
        - emacs-goodies
        - firefox
        - git
        - gnupg2
        - google-chrome-stable
        - gwenview
        - highlight
        - hplip
        - kde-connect
        - kdesu
        - keepassxc
        - kgpg
        - konversation
        - krb5-workstation
        - ksysguard
        - kwalletmanager
        - libnotify
        - libreoffice-calc
        - libreoffice-draw
        - libreoffice-impress
        - libreoffice-langpack-en
        - libreoffice-writer
        - okular
        - openssh-clients
        - openvpn
        - python3-keyring
        - python3-qt5
        - pwgen
        - redhat-internal-NetworkManager-openvpn-profiles-non-gnome
        - redhat-internal-cert-install
        - redhat-lsb-core
#        - rh-osbs
#        - rhpkg
        - slack
        - srcclr
        - subversion
        - thunderbird
        - wireshark
        - vlc
        - xclip
        - yarock
        - xorg-x11-server-utils
        - zsh
      state: present

  - name: Install secondary software (development)
    dnf:
      name:
        - cmake
        - cpio
#        - kernel-tools
        - kf5-kpackage
        - make
        - mock
        - dmidecode
        - lm_sensors
        - podman
        - python3-jenkins-job-builder
#        - rpmdiff
        - texlive-bibtex
        - texlive-latex
      state: present

  - block:
    - name: Clean bootstrap VPN
      file:
        state: absent
        path: "/etc/NetworkManager/system-connections/{{ vpn_filename }}"
    # Network will be reloaded on system reboot anyway
    - name: Reload network
      command: nmcli connection reload
    when: vpn_bootstrap == True

  - name: Patch VPN
    lineinfile:
      path: "{{ item }}"
      insertafter: "tunnel-mtu=1360"
      line: "username={{ vpn_username }}"
    with_fileglob:
      - "/etc/NetworkManager/system-connections/*.ovpn"

  - name: Allow port ranges for KDEConnect
    firewalld:
      immediate: yes
      permanent: true
      state: enabled
      port: '{{ item }}'
    with_items:
      - "1714-1764/udp"
      - "1714-1764/tcp"

  - name: Patch krb5.conf
    template:
      src: krb5.conf.j2
      dest: /etc/krb5.conf

  - name: User account configuration
    include_role:
      name: user
